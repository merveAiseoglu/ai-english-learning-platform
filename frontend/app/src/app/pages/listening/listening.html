<div class="listening-container">
  <!-- Metin seÃ§ici -->
  <div *ngIf="texts.length > 1" class="text-selector">
    <label for="textSelect" class="text-selector-label">ğŸ“š Metin SeÃ§:</label>
    <select
      #selectEl
      (change)="onTextSelect(+selectEl.value)"
      [disabled]="isLoading"
      id="textSelect"
      class="text-selector-dropdown"
    >
      <option *ngFor="let text of texts; let i = index" [value]="i">
        {{ text.title }}
      </option>
    </select>
  </div>

  <div *ngIf="currentText" class="listening-exercise">
    <!-- BaÅŸlÄ±k -->
    <div class="header-section">
      <h1 class="main-title">ğŸ§ {{ currentText.title }}</h1>
    </div>

    <!-- Loading gÃ¶stergesi -->
    <div *ngIf="showLoading" class="loading-indicator">
      <div class="loading-icon">â³</div>
      <span class="loading-text">Audio yÃ¼kleniyor...</span>
    </div>

    <!-- Hata mesajÄ± -->
    <div *ngIf="showError" class="error-message">
      <div class="error-icon">âš ï¸</div>
      <span class="error-text">{{ audioError }}</span>
    </div>

    <!-- Ses kontrolleri -->
    <div class="audio-controls">
      <button
        (click)="playAudio()"
        [disabled]="!canPlay || isPlaying"
        class="btn btn-play"
        [class.playing]="isPlaying"
        [class.disabled]="!canPlay || isPlaying"
      >
        <span *ngIf="!isPlaying && !showLoading">â–¶ï¸ Play</span>
        <span *ngIf="isPlaying">ğŸµ OynatÄ±lÄ±yor</span>
        <span *ngIf="showLoading">â³ YÃ¼kleniyor</span>
      </button>

      <button
        (click)="pauseAudio()"
        [disabled]="!canPlay || !isPlaying"
        class="btn btn-pause"
        [class.disabled]="!canPlay || !isPlaying"
      >
        â¸ Pause
      </button>

      <button
        (click)="restartAudio()"
        [disabled]="!canPlay"
        class="btn btn-restart"
        [class.disabled]="!canPlay"
      >
        ğŸ”„ Restart
      </button>
    </div>

    <!-- HÄ±z kontrolÃ¼ -->
    <div class="speed-control">
      <label class="speed-label">âš¡ Oynatma HÄ±zÄ±:</label>
      <div class="speed-buttons">
        <button
          *ngFor="let rate of availableRates"
          (click)="changePlaybackRate(rate)"
          class="speed-btn"
          [class.active]="playbackRate === rate"
        >
          {{ rate }}x
        </button>
      </div>
    </div>

    <!-- Progress bar -->
    <div class="progress-section">
      <div class="progress-time">
        <span class="current-time">{{ formatTime(currentTime) }}</span>
        <span class="duration-label">ğŸµ Audio SÃ¼resi</span>
        <span class="total-time">{{ formatTime(duration) }}</span>
      </div>

      <div class="progress-bar-container" (click)="onProgressBarClick($event)">
        <div class="progress-bar" [style.width.%]="getProgressPercentage()">
          <div class="playhead"></div>
        </div>
      </div>

      <div class="progress-percentage">
        {{ getProgressPercentage() | number : "1.0-0" }}% tamamlandÄ±
      </div>
    </div>

    <!-- Audio durumu -->
    <div *ngIf="canPlay && !showLoading && !showError" class="audio-status">
      <span class="status-text" [class.playing]="isPlaying">
        {{ isPlaying ? "ğŸ”Š Ses oynatÄ±lÄ±yor" : "ğŸµ Ses hazÄ±r" }}
      </span>
    </div>
  </div>

  <!-- EGZERSÄ°Z ALANI -->
  <div *ngIf="currentText" class="exercise-area">
    <!-- EGZERSÄ°Z TÃœRÃœ SEÃ‡Ä°MÄ° -->
    <div class="exercise-type-selector">
      <h3 class="exercise-title">ğŸ¯ Egzersiz TÃ¼rÃ¼ SeÃ§in</h3>
      <div class="exercise-buttons">
        <button
          (click)="switchExerciseType('blanks')"
          class="exercise-btn"
          [class.active]="currentExerciseType === 'blanks'"
        >
          ğŸ“ BoÅŸluk Doldurma
        </button>

        <button
          (click)="switchExerciseType('multiple-choice')"
          class="exercise-btn"
          [class.active]="currentExerciseType === 'multiple-choice'"
        >
          ğŸ¯ Ã‡oktan SeÃ§meli
          <span class="question-count"
            >({{ currentText?.multipleChoiceQuestions?.length || 0 }})</span
          >
        </button>

        <button
          (click)="switchExerciseType('true-false')"
          class="exercise-btn"
          [class.active]="currentExerciseType === 'true-false'"
        >
          âœ… DoÄŸru/YanlÄ±ÅŸ
          <span class="question-count"
            >({{ currentText?.trueFalseQuestions?.length || 0 }})</span
          >
        </button>
      </div>
    </div>

    <!-- 1. BOÅLUK DOLDURMA EGZERSÄ°ZÄ° -->
    <div *ngIf="currentExerciseType === 'blanks'" class="blanks-exercise">
      <div class="exercise-header">
        <h3 class="exercise-section-title">ğŸ“ BoÅŸluk Doldurma Egzersizi</h3>
        <p class="exercise-description">
          DinlediÄŸiniz kelimeleri boÅŸ alanlara yazÄ±n
        </p>
      </div>

      <div
        class="listening-text-container"
        [class.disabled]="showLoading || showError"
      >
        <p class="listening-text">
          <ng-container *ngFor="let word of currentWords; let i = index">
            <ng-container *ngIf="blanksIndices.includes(i); else normalWord">
              <input
                type="text"
                [(ngModel)]="userInputs[i]"
                placeholder="..."
                size="12"
                class="word-input"
                [class.correct]="
                  checkResults &&
                  checkResults[blanksIndices.indexOf(i)]?.includes('âœ”')
                "
                [class.incorrect]="
                  checkResults &&
                  checkResults[blanksIndices.indexOf(i)]?.includes('âœ˜')
                "
              />
            </ng-container>
            <ng-template #normalWord>
              <span class="normal-word">{{ word }}</span>
            </ng-template>
          </ng-container>
        </p>
      </div>

      <!-- BoÅŸluk doldurma kontrol butonu -->
      <div class="check-section">
        <button
          (click)="checkResults = checkAnswers()"
          [disabled]="showLoading || showError"
          class="btn btn-check"
        >
          ğŸ” BoÅŸluklarÄ± Kontrol Et
        </button>

        <button
          *ngIf="checkResults"
          (click)="checkResults = null; userInputs = {}"
          class="btn btn-reset"
        >
          ğŸ”„ SÄ±fÄ±rla
        </button>
      </div>

      <!-- BoÅŸluk doldurma sonuÃ§larÄ± -->
      <div *ngIf="checkResults" class="results-section">
        <h4 class="results-title">ğŸ“Š BoÅŸluk Doldurma SonuÃ§larÄ±</h4>
        <div class="results-grid">
          <div
            *ngFor="let res of checkResults; let i = index"
            class="result-item"
            [class.correct]="res.includes('âœ”')"
            [class.incorrect]="res.includes('âœ˜')"
          >
            <span class="result-icon">{{
              res.includes("âœ”") ? "âœ…" : "âŒ"
            }}</span>
            <strong>BoÅŸluk {{ i + 1 }}:</strong> {{ res }}
          </div>
        </div>

        <div class="score-card">
          ğŸ† BoÅŸluk Doldurma Skoru: {{ getCorrectAnswersCount() }} /
          {{ checkResults.length }} ({{ getScorePercentage() }}%)
        </div>
      </div>
    </div>

    <!-- 2. Ã‡OKTAN SEÃ‡MELÄ° EGZERSÄ°ZÄ° -->
    <div
      *ngIf="currentExerciseType === 'multiple-choice'"
      class="multiple-choice-exercise"
    >
      <div class="exercise-header">
        <h3 class="exercise-section-title">ğŸ¯ Ã‡oktan SeÃ§meli Sorular</h3>
        <p class="exercise-description">DoÄŸru seÃ§eneÄŸi iÅŸaretleyin</p>
      </div>

      <div
        *ngIf="
          currentText?.multipleChoiceQuestions &&
          currentText.multipleChoiceQuestions.length > 0
        "
      >
        <div
          *ngFor="
            let question of currentText.multipleChoiceQuestions;
            let qIndex = index
          "
          class="question-container mc-question"
        >
          <h4 class="question-title">
            Soru {{ qIndex + 1 }}: {{ question.question }}
          </h4>

          <div class="options">
            <div
              *ngFor="let option of question.options; let optIndex = index"
              class="option-item"
            >
              <label class="option-label">
                <input
                  type="radio"
                  [name]="'mc_' + question.id"
                  [value]="optIndex"
                  [(ngModel)]="multipleChoiceAnswers[question.id]"
                  class="option-radio"
                />
                <span class="option-text"
                  >{{ getOptionLetter(optIndex) }}) {{ option }}</span
                >
              </label>
            </div>
          </div>

          <!-- SonuÃ§ gÃ¶stergesi -->
          <div
            *ngIf="mcQuestionResults[question.id] !== undefined"
            class="question-result"
            [class.correct]="mcQuestionResults[question.id]"
            [class.incorrect]="!mcQuestionResults[question.id]"
          >
            <strong class="result-status">
              {{ mcQuestionResults[question.id] ? "âœ… DoÄŸru!" : "âŒ YanlÄ±ÅŸ!" }}
            </strong>
            <div class="explanation">{{ question.explanation }}</div>
          </div>
        </div>

        <!-- Ã‡oktan seÃ§meli kontrol butonu -->
        <div class="check-section">
          <button
            (click)="checkMultipleChoiceAnswers()"
            class="btn btn-check-mc"
          >
            ğŸ¯ Ã‡oktan SeÃ§meli CevaplarÄ± Kontrol Et
          </button>
        </div>
      </div>

      <div
        *ngIf="
          !currentText?.multipleChoiceQuestions ||
          currentText.multipleChoiceQuestions.length === 0
        "
        class="no-content"
      >
        Bu metin iÃ§in Ã§oktan seÃ§meli soru bulunmamaktadÄ±r.
      </div>
    </div>

    <!-- 3. DOÄRU/YANLIÅ EGZERSÄ°ZÄ° -->
    <div
      *ngIf="currentExerciseType === 'true-false'"
      class="true-false-exercise"
    >
      <div class="exercise-header">
        <h3 class="exercise-section-title">âœ… DoÄŸru/YanlÄ±ÅŸ SorularÄ±</h3>
        <p class="exercise-description">
          Ä°fadelerin doÄŸru mu yanlÄ±ÅŸ mÄ± olduÄŸunu belirleyin
        </p>
      </div>

      <div
        *ngIf="
          currentText?.trueFalseQuestions &&
          currentText.trueFalseQuestions.length > 0
        "
      >
        <div
          *ngFor="
            let question of currentText.trueFalseQuestions;
            let qIndex = index
          "
          class="question-container tf-question"
        >
          <h4 class="question-title">
            Ä°fade {{ qIndex + 1 }}: {{ question.statement }}
          </h4>

          <div class="tf-options">
            <label class="tf-option true-option">
              <input
                type="radio"
                [name]="'tf_' + question.id"
                [value]="true"
                [(ngModel)]="trueFalseAnswers[question.id]"
                class="tf-radio"
              />
              <span class="tf-text">âœ… DOÄRU</span>
            </label>

            <label class="tf-option false-option">
              <input
                type="radio"
                [name]="'tf_' + question.id"
                [value]="false"
                [(ngModel)]="trueFalseAnswers[question.id]"
                class="tf-radio"
              />
              <span class="tf-text">âŒ YANLIÅ</span>
            </label>
          </div>

          <!-- SonuÃ§ gÃ¶stergesi -->
          <div
            *ngIf="tfQuestionResults[question.id] !== undefined"
            class="question-result"
            [class.correct]="tfQuestionResults[question.id]"
            [class.incorrect]="!tfQuestionResults[question.id]"
          >
            <strong class="result-status">
              {{ tfQuestionResults[question.id] ? "âœ… DoÄŸru!" : "âŒ YanlÄ±ÅŸ!" }}
            </strong>
            <div class="explanation">{{ question.explanation }}</div>
          </div>
        </div>

        <!-- DoÄŸru/YanlÄ±ÅŸ kontrol butonu -->
        <div class="check-section">
          <button (click)="checkTrueFalseAnswers()" class="btn btn-check-tf">
            âœ… DoÄŸru/YanlÄ±ÅŸ CevaplarÄ± Kontrol Et
          </button>
        </div>
      </div>

      <div
        *ngIf="
          !currentText?.trueFalseQuestions ||
          currentText.trueFalseQuestions.length === 0
        "
        class="no-content"
      >
        Bu metin iÃ§in doÄŸru/yanlÄ±ÅŸ sorusu bulunmamaktadÄ±r.
      </div>
    </div>

    <!-- GENEL SKOR Ã–ZETÄ° -->
    <div *ngIf="hasAnyResults()" class="overall-score">
      <h2 class="overall-title">ğŸ† GENEL BAÅARI DURUMUNUZ</h2>

      <div class="score-cards">
        <!-- BoÅŸluk Doldurma Skoru -->
        <div *ngIf="checkResults" class="score-card-item">
          <div class="score-icon">ğŸ“</div>
          <div class="score-label">BoÅŸluk Doldurma</div>
          <div class="score-value">
            {{ getCorrectAnswersCount() }} / {{ checkResults.length }}
          </div>
        </div>

        <!-- Ã‡oktan SeÃ§meli Skoru -->
        <div *ngIf="hasMCResults()" class="score-card-item">
          <div class="score-icon">ğŸ¯</div>
          <div class="score-label">Ã‡oktan SeÃ§meli</div>
          <div class="score-value">
            {{ getMCCorrectCount() }} /
            {{ currentText?.multipleChoiceQuestions?.length || 0 }}
          </div>
        </div>

        <!-- DoÄŸru/YanlÄ±ÅŸ Skoru -->
        <div *ngIf="hasTFResults()" class="score-card-item">
          <div class="score-icon">âœ…</div>
          <div class="score-label">DoÄŸru/YanlÄ±ÅŸ</div>
          <div class="score-value">
            {{ getTFCorrectCount() }} /
            {{ currentText?.trueFalseQuestions?.length || 0 }}
          </div>
        </div>
      </div>

      <!-- Toplam Skor -->
      <div class="total-score">
        <div class="total-label">TOPLAM BAÅARI ORANI</div>
        <div class="total-value">
          {{ getOverallScore().correct }} / {{ getOverallScore().total }}
          <span class="total-percentage"
            >({{ getOverallScore().percentage }}%)</span
          >
        </div>

        <!-- BaÅŸarÄ± durumu mesajÄ± -->
        <div class="success-message">
          <span *ngIf="getOverallScore().percentage >= 90" class="excellent"
            >ğŸŒŸ MÃ¼kemmel! Harika iÅŸ Ã§Ä±kardÄ±nÄ±z!</span
          >
          <span
            *ngIf="
              getOverallScore().percentage >= 70 &&
              getOverallScore().percentage < 90
            "
            class="good"
            >ğŸ‘ Ä°yi! BaÅŸarÄ±yla tamamladÄ±nÄ±z!</span
          >
          <span
            *ngIf="
              getOverallScore().percentage >= 50 &&
              getOverallScore().percentage < 70
            "
            class="fair"
            >ğŸ’ª Fena deÄŸil! Biraz daha pratik yapabilirsiniz!</span
          >
          <span *ngIf="getOverallScore().percentage < 50" class="needs-work"
            >ğŸ“š Tekrar dinleyip pratik yapmanÄ±zÄ± Ã¶neririz!</span
          >
        </div>
      </div>
    </div>
  </div>

  <!-- HiÃ§ metin yoksa -->
  <div *ngIf="texts.length === 0" class="no-content">
    <p>Metinler yÃ¼kleniyor...</p>
  </div>
</div>